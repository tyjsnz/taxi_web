# Web端项目文档
## websocket消息服务器
- 使用了独立的消息服务，采用node来实现，参见项目同级目录的node_websocket项目，要node独立启动

## websocket消息客户端
- src/libs/websocket_service.py为项目redis消息订阅服务，需要至路径下进行独立启动,项目中的消息推送到redis中，websocket_service.py为消息订阅服务，将redis中的消息推送给node_websocket的websocket服务器，通过服务端来转发给乘客及司机客户端，项目启动时需要启动
```
python3 websocket_service.py
```
如在本地测试，则要更改websocket_service.py中的socket服务地址为ws://127.0.0.1:8080?client_id=11flask_backend&token=your_secret_token，如在服务端则使用127.0.0.1:8080?client_id=11flask_backend&token=your_secret_token即可
  
## websocket消息订阅服务
- src/common/websocket_manager.py为项目消息推送服务，封装使用redis来完成消息推送
- driver_find_libs.py为定时任务服务，封装使用apscheduler完成定时任务，因任务为多进程，所以需要在其中使用redis来完成消息推送

## 自动任务
- 1、定时任务ScheduleService.py,到以下目录运行独立任务：
  - 运行脚本：service/run.sh
  

# Android项目文档
- 听单语音采用了讯飞语音合成

# websocket消息服务器
- 使用了独立的消息服务，采用node来实现，参见项目同级目录的node_websocket项目，要node独立启动
- 1、运行websocket服务器
```
nohup node server.js > app.log 2>&1 &
```
- 2、运行websocket客户端
```
cd /www/wwwroot/web/src/libs/websocket_client/
./run.sh
```
- 3、启动自动服务
```
cd /www/wwwroot/web/src/service/
./run.sh
```

# 小程序端websocket连接方式为wss，注意ws不能连接
```
wss://ws.xxx.net/ws/ 必须以此开头
wss://ws.xxx.net/ws/?client_id=11flask_backend&token=your_secret_token
```

### nginx中需要配置反向代理
```
server
{
    listen 80;
    listen 443 ssl http2 ;
    server_name wxapp.xxx.net;
    index index.html index.htm default.htm default.html;
    root /www/wwwroot/web;

    #SSL-START SSL相关配置
    #error_page 404/404.html;
    ssl_certificate    /www/server/panel/vhost/cert/web/fullchain.pem;
    ssl_certificate_key    /www/server/panel/vhost/cert/web/privkey.pem;
    ssl_protocols TLSv1.1 TLSv1.2 TLSv1.3;
    ssl_ciphers EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    add_header Strict-Transport-Security "max-age=31536000";
    error_page 497  https://$host$request_uri;

    
    #SSL-END

    #ERROR-PAGE-START  错误页相关配置
    #error_page 404 /404.html;
    #error_page 502 /502.html;
    #ERROR-PAGE-END


    #REWRITE-START 伪静态相关配置
    include /www/server/panel/vhost/rewrite/python_web.conf;
    #REWRITE-END

    #禁止访问的文件或目录
    location ~ ^/(\.user.ini|\.htaccess|\.git|\.svn|\.project|LICENSE|README.md|package.json|package-lock.json|\.env) {
        return 404;
    }

    #一键申请SSL证书验证目录相关设置
    location /.well-known/ {
        root /www/wwwroot/java_node_ssl;
    }

    #禁止在证书验证目录放入敏感文件
    if ( $uri ~ "^/\.well-known/.*\.(php|jsp|py|js|css|lua|ts|go|zip|tar\.gz|rar|7z|sql|bak)$" ) {
        return 403;
    }

    # HTTP反向代理相关配置开始 >>>
    location ~ /purge(/.*) {
        proxy_cache_purge cache_one 127.0.0.1$request_uri$is_args$args;
    }

    location /ws/ {
        # 反向代理到后端WS服务
        proxy_pass http://127.0.0.1:8088;
        
        # WebSocket协议升级关键配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;  # 建议修改此项[6,7](@ref)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 长连接超时设置（防止断开）[4](@ref)
        proxy_connect_timeout 60s;
        proxy_read_timeout 86400s;  # 保持长连接
        proxy_send_timeout 86400s;
    }
    
    location / {
        proxy_pass http://127.0.0.1:8002;
        proxy_set_header Host 127.0.0.1:$server_port;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header REMOTE-HOST $remote_addr;
        add_header X-Cache $upstream_cache_status;
        proxy_set_header X-Host $host:$server_port;
        proxy_set_header X-Scheme $scheme;
        proxy_connect_timeout 30s;
        proxy_read_timeout 86400s;
        proxy_send_timeout 30s;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    
    # HTTP反向代理相关配置结束 <<<

    access_log  /www/wwwlogs/web.log;
    error_log  /www/wwwlogs/web.error.log;
}
```

## 高德key
- webapi key：<xxxx> 用于地址搜索sel_address.html，热力图hot_map.html

## 人脸识别
- 微云下载腾讯人脸识别sdk
- https://www.weiyun.com/disk/folder/719255106c01b37d675fb2964bbd980f
  控制台：https://console.cloud.tencent.com/faceid/access
  
## 程序版本管理
- master为主版本
- dev_master为开发版本，开发版本代码提交到dev_master分支，dev_master分支合并到master分支，再发布到生产环境
- git branch -r 列出所有远程分支
- git checkout -b dev_master origin/dev_master 切换本地分支为dev_master分支
- 让 Git 忽略你对它的本地修改，但版本库中存在
  - git update-index --skip-worktree settings.py
  - #撤销此设置​（如果需要重新跟踪）：
  - git update-index --no-skip-worktree settings.py

## 环境
- git 管理，每次修改完成先git commit -m "描述"，再git pull，最后 git push
- anaconda 虚拟环境，python版本 >= 3.8
- pip install -r requirements.txt 进行依赖包的安装
- 使用Redis缓存系统  pip install redis  (已带消息队列)
- vscode 插件drawio可打开docs目录下.drawio.svg文件

## 项目依赖包
- pip install --upgrade tencentcloud-sdk-python-common -i https://mirrors.aliyun.com/pypi/simple
- pip install --upgrade tencentcloud-sdk-python-ocr -i https://mirrors.aliyun.com/pypi/simple
pip install alibabacloud_dysmsapi20170525==3.1.0 -i https://mirrors.aliyun.com/pypi/simple

## websocket连接信息
- ws://127.0.0.1:19001/websocket

## websocket 消息结构
- 主体消息结构必要字段，除必要字段外其余字段则由用户自行协商扩展。如必要字段缺失则做断开处理
    - flag：标识，用于区分消息类型，必填
    - target_token：要接收消息的用户token，必填
    - token：发送消息的用户token，必填

- 客户端登录时2秒内必须发如下格式数据，否则做断开处理，登录成功则服务端不反馈数据：
	```
	{"flag":"login","token":"登录用户的token"}
	```
- 1、司机端向乘客端发送定位消息为如下格式,同样也适用乘客向司机端发送消息，格式可自行协商扩展除必要字段，必须字段在每次发送消息时服务端都要做验证，否则做断开处理：
	```
	{
		"flag":"latlng", // 标识（必要）
		"target_token":"abcdefg", // 要接收消息的用户token（必要）
		"token":"hijk", // 发送消息的用户token（必要）
		"lat":"23.11",  // 当前位置的纬度
		"lng":"113.11"  // 当前位置的经度
	}
	```
- 2、乘客下单司机接单后，乘客向司机发送如下定位及路线消息
	```
	{
		"flag":"travel", // 行程信息标识（必要）
		"target_token":"abcdefg", // 要接收消息的司机token（必要）
		"token":"hijk", // 乘客token（必要）
		"lat":"23.11",  // 当前位置的纬度
		"lng":"113.11",  // 当前位置的经度
		"start": "出发点",
		"end": "目的地",
		"phone": "乘客手机号"
		"msg": "乘客消息内容"
	}
	```
- 3、司机接单后，收到乘客发送2的行程信息后，司机向乘客发送接驾路线信息。
	```
	{
		"flag":"pickup", // 接驾信息标识（必要）
		"target_token":"abcdefg", // 要接收消息的乘客token（必要）
		"token":"hijk", // 司机token（必要）
		"lat":"23.11",  // 当前位置的纬度
		"lng":"113.11",  // 当前位置的经度
		"start": "出发点",
		"end": "接驾目的地",
		"msg": "司机消息内容",
		"phone": "司机手机号"
	}
	```
- 4、退出登录时，发送如下格式数据，服务端收到后断开连接，不返回数据：
    ```
    {"flag": "close","token": "abcdefg"}
    ```