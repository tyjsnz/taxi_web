<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>我的卡券</title>
  <!-- 引入Vue和ElementUI CDN -->
  <script src="/static/libs/element-ui/js/vue.js"></script>
  <script src="/static/libs/element-ui/js/element-ui.js"></script>
  <link rel="stylesheet" href="/static/libs/element-ui/css/element-ui.css">
  <script src="/static/libs/wechat/jweixin-1.3.2.js"></script>
  <script type="text/javascript" src="/static/libs/wechat/uni.webview.1.5.6.js"></script>
  <script src="/static/common/jquery.3.7.1.js"></script>
  <script src="/static/utils/helper.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
    }
    
    .coupon-container {
      max-width: 100%;
      padding: 0;
    }
    
    /* 自定义导航栏 */
    .custom-navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background-color: #fff;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .navbar-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .navbar-back {
      font-size: 20px;
      color: #666;
    }
    
    /* 标签栏 */
    .tabs-container {
      padding: 10px 15px;
      background-color: #fff;
    }
    
    .el-tabs__item {
      font-size: 14px;
      padding: 0 10px;
    }
    
    .el-tabs__item.is-active {
      color: #07C160;
      font-weight: bold;
    }
    
    .el-tabs__active-bar {
      background-color: #07C160;
    }
    
    /* 卡券列表 */
    .coupon-list {
      padding: 15px;
    }
    
    .coupon-item {
      background-color: #fff;
      border-radius: 8px;
      margin-bottom: 15px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .coupon-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px dashed #eee;
    }
    
    .coupon-value {
      font-size: 24px;
      font-weight: bold;
      color: #FF7D00;
    }
    
    .coupon-value::before {
      content: "¥";
      font-size: 16px;
    }
    
    .coupon-type {
      font-size: 12px;
      color: #999;
    }
    
    .coupon-body {
      padding: 15px;
    }
    
    .coupon-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .coupon-desc {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      line-height: 1.5;
    }
    
    .coupon-time {
      font-size: 12px;
      color: #999;
    }
    
    .coupon-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background-color: #f9f9f9;
    }
    
    .coupon-status {
      font-size: 12px;
      color: #07C160;
    }
    
    .coupon-status.used {
      color: #999;
    }
    
    .coupon-status.expired {
      color: #FF4D4F;
    }
    
    .coupon-action {
      font-size: 12px;
      color: #07C160;
      text-decoration: none;
    }
    
    .coupon-action.disabled {
      color: #999;
    }
    
    .empty-tip {
      text-align: center;
      padding: 30px 0;
      color: #999;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app" class="coupon-container">
   
    <!-- 标签栏 -->
    <!-- <div class="tabs-container" style="position: fixed; width: 100%; height: 28px; background-color: #fff;top:0px;">
      <el-tabs v-model="activeTab" @tab-click="handleTabClick" :stretch="true">
        <el-tab-pane label="全部" name="all"></el-tab-pane>
        <el-tab-pane label="待使用" name="unused"></el-tab-pane>
        <el-tab-pane label="已使用" name="used"></el-tab-pane>
        <el-tab-pane label="已过期" name="expired"></el-tab-pane>
      </el-tabs>
    </div> -->
    
    <!-- 卡券列表 -->
    <div class="coupon-list" style="margin-top: 10px;">
      <div v-if="filteredCoupons.length === 0" class="empty-tip">
        暂无卡券
      </div>
      
      <div class="coupon-item" v-for="(item, index) in filteredCoupons" :key="index">
        <div class="coupon-header">
          <div class="coupon-value">${item.amount}</div>
          <div class="coupon-type">${item.type}</div>
        </div>
        
        <div class="coupon-body">
          <div class="coupon-name">${item.name}</div>
          <div class="coupon-desc">${item.description}</div>
          <div class="coupon-time" v-if="item.valid_type==1"> ${item.valid_days}天内使用</div>
          <div class="coupon-time" v-else>有效期至 ${item.end_time}</div>
        </div>
        
        <div class="coupon-footer">
          <div class="coupon-status" :class="item.status">${item.statusText}</div>
          <a href="javascript:;" class="coupon-action" :class="{disabled: item.status != 0}" @click="useCoupon(item)">            
            ${item.status == 0 ? '立即使用' : '已失效'}
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('UniAppJSBridgeReady', function() {
      uni.webView.getEnv(function(res) {
        console.log('当前环境：' + JSON.stringify(res));
      });
      // uni.webView.navigateTo(...)
    });
  </script>


  <script>
    new Vue({
      el: '#app',
      delimiters: ['${', '}'],
      data() {
        return {
          uid: "{{session['uid']}}",
          token: "{{session['session']}}",
          openid: "{{session['openid']}}",
          activeTab: 'all',
          couponList: []
        }
      },
      mounted() {
        // // 或者
        window.wx.miniProgram.getEnv(function(res) {
          console.log('vue',res.miniprogram) // true
        })
      },
      computed: {
        filteredCoupons() {
          if (this.activeTab === 'all') {
            return this.couponList;
          }
          return this.couponList.filter(item => item.status === this.activeTab);
        }
      },
      mounted() {
        this.get_coupon_list()
      },
      methods: {
        get_coupon_list() {
          var that = this
          $.ajax({
            url: '/wechat/api/v1/web/member/coupon_list/json',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
              console.log(data)
              that.couponList = data.data
              for (let i in that.couponList) {
                switch (that.couponList[i].type) {
                  case "1":
                    that.couponList[i].type = '代金券'
                    break;
                  case 2:
                    that.couponList[i].type = '满减券'
                    break;
                  case 3:
                    that.couponList[i].type = '拉新券'
                    break;
                }
                // 动态时间，领取后几天
                if (that.couponList[i].valid_type == 1) {
                  let ret = get_expirt_time(that.couponList[i].created_at, that.couponList[i].valid_days)
                  that.couponList[i].status = ret[0]
                    that.couponList[i].statusText = ret[1]
                }
              }
            },
          })
        },
        goBack() {
          // 返回上一页逻辑
          console.log('返回');
        },
        handleTabClick(tab) {
          console.log('切换标签:', tab.name);
        },
        useCoupon(item) {
          if (item.status !== 0) {
            return;
          }
          console.log('使用卡券:', item);
          
          // 注意uni.postMessage使用情况下就不要使用uni.redirectTo，或reLanch, 此时可以在/trip/list页面中接收消息，然后跳转到对应页面          
          /*uni.postMessage({
            data: {
              'type': 'goto_url',
              'url': '/pages/user/user',
            }
          });
          // 只发消息过去，则不需要跳转
          uni.navigateBack()*/
          
          // uni.redirectTo({
          //   url: '/pages/trip/list?type=coupon_center'
          // });

          // 跳转到用户中心，只关闭当前页面，reLaunch关闭所有页面
          uni.redirectTo({
            url: '/pages/index/index'
          })
        }
      }
    });
  </script>
</body>
</html>