<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>我的行程</title>
  <!-- 引入Vue和ElementUI CDN -->
  <script src="/static/libs/element-ui/js/vue.js"></script>
  <script src="/static/libs/element-ui/js/element-ui.js"></script>
  <script src="/static/common/jquery.3.7.1.js"></script>
  <link rel="stylesheet" href="/static/libs/element-ui/css/element-ui.css">
  <script src="/static/libs/wechat/jweixin-1.3.2.js"></script>
  <script type="text/javascript" src="/static/libs/wechat/uni.webview.1.5.6.js"></script>

  <style>
    [v-cloak] {
      display: none;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #fff;
      color: #333;
    }

    .trip-container {
      max-width: 100%;
      padding: 0;
    }

    /* 自定义导航栏 */
    .custom-navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #f5f5f5;
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 100;
    }

    .navbar-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .navbar-back {
      font-size: 20px;
      color: #666;
    }

    .navbar-more {
      font-size: 20px;
      color: #666;
    }

    /* 标签栏 */
    .tabs-container {
      padding: 10px 15px;
      border-bottom: 1px solid #f5f5f5;
    }

    .el-tabs__item {
      font-size: 14px;
      padding: 0 10px;
    }

    .el-tabs__item.is-active {
      color: #07C160;
      font-weight: bold;
    }

    .el-tabs__active-bar {
      background-color: #07C160;
    }

    /* 订单列表 */
    .order-list {
      padding: 0 15px;
    }

    .section-title {
      font-size: 14px;
      color: #999;
      padding: 15px 0 10px;
    }

    .order-item {
      padding: 15px 0;
      border-bottom: 1px solid #f5f5f5;
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .service-type {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    .status {
      font-size: 12px;
    }

    .status.completed {
      color: #07C160;
    }

    .status.closed {
      color: #FF4D4F;
    }

    .order-time {
      font-size: 12px;
      color: #999;
      margin-bottom: 10px;
    }

    .price {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .price.refund {
      color: #999;
    }

    .location {
      margin-bottom: 15px;
    }

    .start,
    .end {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      display: flex;
      align-items: center;
    }

    .start::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #07C160;
      border-radius: 50%;
      margin-right: 8px;
    }

    .end::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #FF7D00;
      border-radius: 50%;
      margin-right: 8px;
    }

    .actions {
      display: flex;
    }

    .action-btn {
      margin-right: 10px;
      padding: 0 15px;
      height: 28px;
      line-height: 28px;
      font-size: 12px;
      color: #666;
      background-color: #f5f5f5;
      border-radius: 14px;
      border: none;
      outline: none;
    }
    .pay{
      background-color: #1aad19;
      color: #f1f1f1;
    }

    .empty-tip {
      text-align: center;
      padding: 30px 0;
      color: #999;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="app" class="trip-container" v-cloak>
    <!-- 自定义导航栏 -->
    <!-- <div class="custom-navbar">
      <div class="navbar-back" @click="goBack">←</div>
      <div class="navbar-title">我的行程</div>
      <div class="navbar-more" @click="showMore">⋮</div>
    </div> -->

    <!-- 标签栏 -->
    <div class="tabs-container"
      style="position: fixed; width: 100%; height: 28px; background-color: #fff;top:0px; display: none;">
      <el-tabs v-model="activeTab" @tab-click="handleTabClick" :stretch="true">
        <el-tab-pane label="全部" name="all"></el-tab-pane>
        <el-tab-pane label="快车" name="taxi"></el-tab-pane>
        <el-tab-pane label="城际快车" name="carpool"></el-tab-pane>
      </el-tabs>
    </div>

    <!-- 订单列表 -->
    <div class="order-list" style="margin-top: 10px;">

      <div v-if="orderList.length === 0" class="empty-tip">
        暂无行程订单
      </div>
      <!-- 订单项 -->
      <div class="order-item" v-for="(item, index) in orderList" :key="index">
        <div class="order-header">
          <div class="service-type">快车</div>
          <div class="status" :class="item.status">${item.status_txt}</div>
        </div>

        <div class="order-time">${item.order_time}</div>

        <div class="price">${item.total_fee}元</div>
        <!-- <div class="price refund" v-else></div> -->

        <div class="location">
          <div class="start">${item.start_location}</div>
          <div class="end">${item.end_location}</div>
        </div>

        <div class="actions">
          <button class="action-btn pay" @click="pay_order(item.id)" v-if="item.status == 4">去支付</button>
          
          <button class="action-btn" @click="handleAction('invoice', item)" v-if="item.status == 5">开发票</button> 

          <!-- <button class="action-btn" @click="handleAction('return', item)">一键返程</button>
          <button class="action-btn" @click="handleAction('again', item)">再来一单</button> -->
        </div>
      </div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      delimiters: ['${', '}'],
      data() {
        return {
          uid: "{{session['uid']}}",
          token: "{{session['session']}}",
          openid: "{{session['openid']}}",
          activeTab: 'all',
          orderList: [
          ]
        }
      },
      mounted() {
        this.get_trip()
      },
      methods: {
        get_trip() {
          var that = this
          this.orderList = []
          $.ajax({
            url: '/wechat/api/v1/web/member/trip/json',
            type: 'get',
            data: {
              uid: this.uid,
              tk: this.token,
              op: this.openid,
            },
            success: (res) => {
              console.log(res);
              that.orderList = res.data;
              for (let i in that.orderList) {
                let status = that.orderList[i].status
                let m = ''
                switch (status) {
                  case '0':
                    m = '待接单'
                    break;
                  case '1':
                    m = '已接单'
                    break;
                  case '2':
                    m = '乘客已上车'
                    break;
                  case '3':
                    m = '行程进行中'
                    break
                  case 4:
                    m = '待支付'
                    break
                  case 5:
                    m = '已完成'
                    break
                  default:
                    m = '已关闭'
                    break
                }
                if (that.orderList[i].total_fee == '' || that.orderList[i].total_fee == null)
                  that.orderList[i].total_fee = that.orderList[i].cost

                that.orderList[i].status_txt = m
              }
            },
            error: (err) => {
            }
          })
        },
        goBack() {
          // 返回上一页逻辑
          console.log('返回');
        },
        showMore() {
          // 显示更多功能
          console.log('显示更多');
        },
        handleTabClick(tab) {
          console.log('切换标签:', tab.name);
          // 这里应该根据标签筛选订单列表
        },
        handleAction(type, order) {
          switch (type) {
            case 'invoice':
              console.log('开发票:', order);
              location.href = '/wechat/api/v1/web/invoice'
              break;
            case 'return':
              console.log('一键返程:', order);
              break;
            case 'again':
              console.log('再来一单:', order);
              break;
          }
        },
        pay_order(order_id) {
          var that = this
          $.ajax({
            url: '/wechat/api/v1/web/member/order/detail',
            type: 'post',
            data: {
              uid: this.uid,
              tk: this.token,
              op: this.openid,
              order_id: order_id
            },
            dataType: 'json',
            success: function (res) {
              if (res.status == 0) {
                let item = res.data
                let data = {
                  "order_id": order_id,
                  "order_sn": item.sn,
                  'total_fee': item.total_fee,
                  'add_price': item.add_price,
                  'pay_amount': item.pay_amount,
                  'order_time': item.order_time,
                  'start_location': item.start_location,
                  'end_location': item.end_location,
                  'car_no': item.driver.car_no,
                  'car_type': item.driver.car_type,
                  'car_brand': item.driver.car_brand,
                  'car_color': item.driver.car_color,
                  'truename': item.driver.driver_name,
                }
                orderinfo = JSON.stringify(data)
                uni.redirectTo({
                  url: '/pages/finish/web_pay?type=web&orderinfo=' + orderinfo
                });
              }
            }
          });

        }
      }
    });
  </script>
</body>

</html>