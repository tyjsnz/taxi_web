<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>车辆更换申请</title>
    <!-- 引入Element UI样式 -->
    <link rel="stylesheet" href="/static/libs/element-ui/css/element-ui.css">
    <style>
        [v-cloak] {
            display: none;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f5f5f5;
        }
   
        .header {
            position: fixed;
            top: 45px;
            left: 0;
            right: 0;
            height: 44px;
            background-color: #fff;
            color: #333;
            display: flex;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .header-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
        }
        .back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-container {
            background: white;
            margin: 0px;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
            margin-top: 100px;
        }
        .form-title {
            margin-bottom: 20px;
            text-align: center;
            color: #333;
            font-size: 16px;
        }
        .el-form-item {
            margin-bottom: 22px;
        }
        .submit-btn {
            margin-top: 30px;
            width: 100%;
        }
        .upload-tip {
            font-size: 12px;
            color: #909399;
            margin-top: 5px;
        }
        .fix-header{
            z-index: 11; height: 45px; background-color: #ff6b00; line-height: 30px; width: 100%;
            position: fixed; top: 0px
        }
        .el-button--danger {
            background-color: #ff6b00; 
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="fix-header"></div>
        <!-- 顶部导航栏 -->
        <div class="header">
            <div class="back-btn" @click="goBack">
                <i class="el-icon-arrow-left" style="font-size: 20px;"></i>
            </div>
            <div class="header-title">车辆更换申请</div>
            <div style="width: 44px;"></div>
        </div>

        <!-- 表单内容 -->
        <div class="form-container">
            <el-form :model="form" :rules="rules" ref="form" label-position="top">
                <!-- 车牌号码 -->
                <el-form-item label="车牌号码" prop="plateNumber">
                    <el-input 
                        v-model="form.plateNumber" 
                        placeholder="请输入新车牌号码"
                        clearable>
                    </el-input>
                </el-form-item>
                
                <!-- 车辆品牌 -->
                <el-form-item label="车辆品牌" prop="brand">
                    <el-select 
                        v-model="form.brand" 
                        placeholder="请选择车辆品牌"
                        style="width: 100%">
                        <el-option 
                            v-for="item in brandOptions"
                            :key="item.value"
                            :label="item.label"
                            :value="item.value">
                        </el-option>
                    </el-select>
                </el-form-item>
                
                <!-- 车辆型号 -->
                <el-form-item label="车辆型号" prop="model">
                    <el-input 
                        v-model="form.model" 
                        placeholder="请输入车辆型号"
                        clearable>
                    </el-input>
                </el-form-item>
                
                <!-- 车辆颜色 -->
                <el-form-item label="车辆颜色" prop="color">
                    <el-select 
                        v-model="form.color" 
                        placeholder="请选择车辆颜色"
                        style="width: 100%">
                        <el-option 
                            v-for="item in colorOptions"
                            :key="item.value"
                            :label="item.label"
                            :value="item.value">
                        </el-option>
                    </el-select>
                </el-form-item>
                
                <!-- 车辆注册日期 -->
                <el-form-item label="车辆注册日期" prop="registerDate">
                    <el-date-picker
                        v-model="form.registerDate"
                        type="date"
                        placeholder="选择注册日期"
                        value-format="yyyy-MM-dd"
                        style="width: 100%">
                    </el-date-picker>
                </el-form-item>
                
                <!-- 行驶证照片 -->
                <el-form-item label="行驶证照片" prop="licenseImage">
                    <el-upload
                        name="file"
                        action="/app/driver/change_car/upload_img?flag=licenseImage"
                        :limit="1"
                        :on-exceed="handleExceed"
                        :before-upload="beforeUpload"
                        :on-success="handleLicenseSuccess"
                        list-type="picture-card"
                        :auto-upload="true">
                        <i class="el-icon-plus"></i>
                    </el-upload>
                    <div class="upload-tip">请上传清晰的行驶证照片（正面）</div>
                </el-form-item>
                
                <!-- 车辆照片 -->
                <el-form-item label="车辆照片" prop="carImage">
                    <el-upload
                        action="/app/driver/change_car/upload_img?flag=card"
                        :limit="3"
                        :on-exceed="handleExceed"
                        :before-upload="beforeUpload"
                        :on-success="handleCarImageSuccess"
                        list-type="picture-card"
                        :auto-upload="true">
                        <i class="el-icon-plus"></i>
                    </el-upload>
                    <div class="upload-tip">请上传车辆正面、侧面、后面照片（最多3张）</div>
                </el-form-item>
                
                <!-- 提交按钮 -->
                <el-form-item>
                    <el-button 
                        type="danger" 
                        class="submit-btn"
                        @click="submitForm"
                        :loading="loading">
                        提交申请
                    </el-button>
                </el-form-item>
            </el-form>
        </div>
    </div>

    <!-- 引入Vue和Element UI -->
     <script src="/static/libs/element-ui/js/vue.js"></script>
    <script src="/static/libs/element-ui/js/element-ui.js"></script>
    <script src="/static/common/jquery.3.7.1.js"></script>
    
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: false,
                    
                    form: {
                        token: "{{ session.token}}",
                        driver_id: "{{ session.driver_id}}",
                        plateNumber: '',
                        brand: '',
                        model: '',
                        color: '',
                        registerDate: '',
                        licenseImage: null,
                        carImages: []
                    },
                    rules: {
                        plateNumber: [
                            { required: true, message: '请输入车牌号码', trigger: 'blur' },
                            { pattern: /^[京津沪渝冀豫云辽黑湘皖鲁新苏浙赣鄂桂甘晋蒙陕吉闽贵粤青藏川宁琼使领A-Z]{1}[A-Z]{1}[A-Z0-9]{4,5}[A-Z0-9挂学警港澳]{1}$/, 
                              message: '请输入正确的车牌号码', trigger: 'blur' }
                        ],
                        brand: [
                            { required: true, message: '请选择车辆品牌', trigger: 'change' }
                        ],
                        model: [
                            { required: true, message: '请输入车辆型号', trigger: 'blur' }
                        ],
                        color: [
                            { required: true, message: '请选择车辆颜色', trigger: 'change' }
                        ],
                        registerDate: [
                            { required: true, message: '请选择注册日期', trigger: 'change' }
                        ],
                        licenseImage: [
                            { required: true, message: '请上传行驶证照片', trigger: 'change' }
                        ],
                        carImages: [
                            { required: true, message: '请上传车辆照片', trigger: 'change' }
                        ]
                    },
                    brandOptions: [
                        { value: '1', label: '大众' },
                        { value: '2', label: '丰田' },
                        { value: '3', label: '本田' },
                        { value: '4', label: '日产' },
                        { value: '5', label: '比亚迪' },
                        { value: '6', label: '吉利' },
                        { value: '7', label: '其他' }
                    ],
                    colorOptions: [
                        { value: '1', label: '黑色' },
                        { value: '2', label: '白色' },
                        { value: '3', label: '银色' },
                        { value: '4', label: '灰色' },
                        { value: '5', label: '红色' },
                        { value: '6', label: '蓝色' },
                        { value: '7', label: '其他' }
                    ]
                };
            },
            methods: {
                // 返回按钮功能
                goBack() {
                    if (window.android && typeof window.android.goBack === 'function') {
                        window.android.goBack();
                    } else if (window.history.length > 1) {
                        window.history.back();
                    }
                },
                
                // 文件上传相关方法
                handleExceed(files, fileList) {
                    this.$message.warning(`当前限制选择 ${files.length} 个文件，请删除部分文件后重新上传`);
                },
                
                beforeUpload(file) {
                    const isJPG = file.type === 'image/jpeg' || file.type === 'image/png';
                    const isLt2M = file.size / 1024 / 1024 < 2;
                    
                    if (!isJPG) {
                        this.$message.error('上传图片只能是 JPG/PNG 格式!');
                    }
                    if (!isLt2M) {
                        this.$message.error('上传图片大小不能超过 2MB!');
                    }
                    return isJPG && isLt2M;
                },
                
                handleLicenseSuccess(response, file) {
                    //this.form.licenseImage = URL.createObjectURL(file.raw);
                    if(response.code == 200){
                        this.form.licenseImage = response.data.file_key;
                    }
                    console.log(response)
                },
                
                handleCarImageSuccess(response, file) {
                    //this.form.carImages.push(URL.createObjectURL(file.raw));
                    if(response.code == 200){
                        this.form.carImages.push(response.data.file_key)
                    }
                },
                
                add(){
                    var that = this
                    that.loading = true
                    setTimeout(() => {
                        that.loading = false
                    }, 10000);
                    $.ajax({
                        type: "POST",
                        url: "",
                        data: that.form,
                        success: function(data){
                            that.loading = false
                            if(data.status == 0){
                                that.$message({
                                    message: '车辆更换申请已提交，请等待审核',
                                    type: 'success'
                                });
                                // 3秒后返回上一页
                                setTimeout(that.goBack, 3000);
                            }
                            else{
                                that.$message({
                                    message: '车辆更换申请提交失败',
                                    type: 'error'
                                });
                            }
                        }
                    });
                },
                // 提交表单
                submitForm() {
                    this.$refs.form.validate((valid) => {
                        if (valid) {
                            this.add()
                            /*this.loading = true;
                            
                            // 模拟API请求
                            setTimeout(() => {
                                this.loading = false;
                                this.$message({
                                    message: '车辆更换申请已提交，请等待审核',
                                    type: 'success'
                                });
                                
                                // 3秒后返回上一页
                                setTimeout(this.goBack, 3000);
                            }, 1500);*/
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>