<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>修改密码</title>
    <!-- 使用备用CDN源 -->
    <link rel="stylesheet" href="/static/libs/element-ui/css/element-ui.css">
    <style>
        [v-cloak] {
            display: none;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
            background-color: #f5f5f5;
        }
    
        .header {
            /* margin-top: 45px; */
            /* position: fixed; */
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background-color: #fff;
            display: flex;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
        }
        .header-title {
            flex: 1;
            text-align: center;
            font-size: 18px;
        }
        .back-btn {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .form-container {
            background: white;
            margin: 20px;
            padding: 20px;
            border-radius: 4px;
        }
        .el-form-item {
            margin-bottom: 22px;
        }
     .fix-header{
            z-index: 11; height: 45px; background-color: #ff6b00; line-height: 30px; width: 100%;
        }
        .el-button--danger {
            background-color: #ff6b00; 
        }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="fix-header"></div>
        <!-- 顶部导航栏 -->
        <div class="header">
            <div class="back-btn" @click="goBack">
                <i class="el-icon-arrow-left" style="font-size: 20px;"></i>
            </div>
            <div class="header-title">修改密码</div>
            <div style="width: 44px;"></div>
        </div>

        <!-- 密码修改表单 -->
        <div class="form-container">
            <el-form :model="form" :rules="rules" ref="form" label-width="100px" label-position="top">
                <el-form-item label="原密码" prop="oldPassword">
                    <el-input 
                        v-model="form.oldPassword" 
                        placeholder="请输入原密码"
                        type="password"
                        show-password>
                    </el-input>
                </el-form-item>
                
                <el-form-item label="新密码" prop="newPassword">
                    <el-input 
                        v-model="form.newPassword" 
                        placeholder="6-20位字母、数字或符号"
                        type="password"
                        show-password>
                    </el-input>
                </el-form-item>
                
                <el-form-item label="确认密码" prop="confirmPassword">
                    <el-input 
                        v-model="form.confirmPassword" 
                        placeholder="请再次输入新密码"
                        type="password"
                        show-password>
                    </el-input>
                </el-form-item>
                
                <el-form-item>
                    <el-button 
                        type="danger" 
                        @click="submitForm"
                        :loading="loading"
                        style="width: 100%;">
                        确认修改
                    </el-button>
                </el-form-item>
            </el-form>
        </div>
    </div>

    <!-- 使用备用CDN源 -->
    <script src="/static/libs/element-ui/js/vue.js"></script>
    <script src="/static/libs/element-ui/js/element-ui.js"></script>
    <script src="/static/common/jquery.3.7.1.js"></script>
    
    <script>
        new Vue({
            el: '#app', // 改为挂载到#app元素
            delimiters: ['${', '}'],
            data() {
                var validatePass = (rule, value, callback) => {
                    if (!value) return callback(new Error('请输入新密码'));
                    if (value.length < 6) return callback(new Error('密码不能少于6位'));
                    if (value.length > 20) return callback(new Error('密码不能超过20位'));
                    callback();
                };
                
                var validatePass2 = (rule, value, callback) => {
                    if (!value) return callback(new Error('请再次输入密码'));
                    if (value !== this.form.newPassword) return callback(new Error('两次输入不一致'));
                    callback();
                };
                
                return {
                    token: "{{ session.token}}",
                    driver_id: "{{ session.driver_id}}",
                    loading: false,
                    form: {
                        oldPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    },
                    rules: {
                        oldPassword: [
                            { required: true, message: '请输入原密码', trigger: 'blur' }
                        ],
                        newPassword: [
                            { required: true, validator: validatePass, trigger: 'blur' }
                        ],
                        confirmPassword: [
                            { required: true, validator: validatePass2, trigger: 'blur' }
                        ]
                    }
                };
            },
            methods: {
                goBack() {
                    if (window.android && typeof window.android.goBack === 'function') {
                        window.android.goBack();
                    } else if (window.history.length > 1) {
                        window.history.back();
                    }
                },
                update_pwd() { 
                    var that = this
                    that.loading = true;
                    $.ajax({
                        type: "POST",
                        url: "",
                        data: {
                            'driver_id': that.driver_id,
                            'token': that.token,
                            "old_pwd": that.form.oldPassword,
                            "new_pwd": that.form.newPassword,
                            "confirm_pwd": that.form.confirmPassword
                        },
                        dataType: "json",
                        success: function (data) {
                            that.loading = false;
                            if (data.status == 0) {
                                that.$message.success('密码修改成功');
                                setTimeout(that.goBack, 1500);
                            }
                            else {
                                that.$message.error(data.msg);
                            }
                        }

                    })
                },
                submitForm() {
                    this.$refs.form.validate(valid => {
                        if (valid) {
                            this.update_pwd()
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>