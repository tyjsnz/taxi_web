<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>司机提现审核</title>
    <!-- 引入Layui CSS -->
    <link rel="stylesheet" href="/static/libs/layui/css/layui.css">
    <style>
        body {
            background-color: #ffffff;
        }

        .layui-card {
            margin: 15px;
        }

        .statistics-card {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .statistics-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .statistics-value {
            font-size: 24px;
            color: #FF5722;
            font-weight: bold;
        }

        .statistics-label {
            color: #666;
        }

        .withdraw-status-0 {
            color: #FFB800;
        }

        /* 待审核 */
        .withdraw-status-1 {
            color: #1E9FFF;
        }

        /* 审核中 */
        .withdraw-status-2 {
            color: #009688;
        }

        /* 已通过 */
        .withdraw-status-3 {
            color: #FF5722;
        }

        /* 已拒绝 */
        .withdraw-status-4 {
            color: #2F4056;
        }

        /* 已打款 */
    </style>
</head>

<body>
    <div class="layui-fluid">
        <div class="layui-row layui-col-space15">
            <!-- 统计卡片 -->
            <div class="layui-col-md12">
                <div class="statistics-card">
                    <blockquote class="layui-elem-quote" id="total">
                        <div class="layui-row">
                            <div class="layui-col-md3">
                                <div class="statistics-item">
                                    <div class="statistics-value" id="today">¥12,568.00</div>
                                    <div class="statistics-label">今日提现总额</div>
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <div class="statistics-item">
                                    <div class="statistics-value" id="week">¥56,892.00</div>
                                    <div class="statistics-label">本周提现总额</div>
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <div class="statistics-item">
                                    <div class="statistics-value" id="noverify">8</div>
                                    <div class="statistics-label">待审核提现</div>
                                </div>
                            </div>
                            <div class="layui-col-md3">
                                <div class="statistics-item">
                                    <div class="statistics-value" id="month">23</div>
                                    <div class="statistics-label">本月提现总数</div>
                                </div>
                            </div>
                        </div>
                    </blockquote>
                </div>
            </div>

            <!-- 筛选条件 -->
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">筛选条件</div>
                    <div class="layui-card-body">
                        <form class="layui-form">
                            <div class="layui-form-item">
                                <div class="layui-inline">
                                    <label class="layui-form-label">所属公司</label>
                                    <div class="layui-input-inline">
                                        <select id="company" name="company">
                                            <option value="">全部状态</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="layui-inline">
                                    <label class="layui-form-label">司机姓名</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="driver_name" placeholder="请输入司机姓名" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">手机号</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="phone" placeholder="请输入手机号" class="layui-input">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">提现状态</label>
                                    <div class="layui-input-inline">
                                        <select name="status">
                                            <option value="">全部状态</option>
                                            <option value="0">待审核</option>
                                            <option value="1">审核中</option>
                                            <option value="2">已通过</option>
                                            <option value="3">已拒绝</option>
                                            <option value="4">已打款</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <label class="layui-form-label">申请日期</label>
                                    <div class="layui-input-inline">
                                        <input type="text" name="date_range" class="layui-input" id="dateRange"
                                            placeholder="请选择日期范围">
                                    </div>
                                </div>
                                <div class="layui-inline">
                                    <button class="layui-btn" lay-submit lay-filter="search">搜索</button>
                                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 提现列表 -->
            <div class="layui-col-md12">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <div class="layui-row">
                            <div class="layui-col-md6">司机提现申请列表</div>
                            <div class="layui-col-md6" style="text-align: right;">
                                <!-- <button class="layui-btn layui-btn-normal layui-btn-sm" id="exportBtn">导出数据</button> -->
                            </div>
                        </div>
                    </div>
                    <div class="layui-card-body">
                        <table class="layui-hide" id="withdrawTable" lay-filter="withdrawTable"></table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 审核操作模板 -->
    <!-- 修改后的模板语法 -->
    <script type="text/html" id="operationTpl">
    <%# if(d.status == 0 || d.status == 1){ %>
      <button class="layui-btn layui-btn-xs" lay-event="approve">通过</button>
      <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="reject">拒绝</button>
      <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看</button>
    <%# } else { %>
      <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="view">查看详情</button>
    <%# } %>
  </script>

    <script type="text/html" id="statusTpl">
    <%# if(d.status == 0){ %>
      <span class="withdraw-status-0">待审核</span>
    <%# } else if(d.status == 1){ %>
      <span class="withdraw-status-1">审核中</span>
    <%# } else if(d.status == 2){ %>
      <span class="withdraw-status-2">已通过</span>
    <%# } else if(d.status == 3){ %>
      <span class="withdraw-status-3">已拒绝</span>
    <%# } else if(d.status == 4){ %>
      <span class="withdraw-status-4">已打款</span>
    <%# } %>
  </script>

    <!-- 审核对话框 -->
    <div id="auditDialog" style="display: none; padding: 20px;">
        <form class="layui-form">
            <div class="layui-form-item">
                <label class="layui-form-label">提现金额</label>
                <div class="layui-input-block">
                    <input type="text" id="withdrawAmount" class="layui-input" readonly>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label">银行信息</label>
                <div class="layui-input-block">
                    <textarea id="bankInfo" class="layui-textarea" readonly></textarea>
                </div>
            </div>
            <div class="layui-form-item" id="rejectReasonItem" style="display: none;">
                <label class="layui-form-label">拒绝原因</label>
                <div class="layui-input-block">
                    <textarea id="rejectReason" placeholder="请输入拒绝原因" class="layui-textarea"></textarea>
                </div>
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit lay-filter="confirmAudit">确认</button>
                    <button type="button" class="layui-btn layui-btn-primary" id="cancelAudit">取消</button>
                </div>
            </div>
        </form>
    </div>

    <!-- 引入Layui JS -->
    <script src="/static/libs/layui/layui.js"></script>

    <script>
        var _company = []
        var _total = []
        // 在初始化Layui之前配置模板分隔符
        layui.config({
            base: '/static/libs/layui/' // 配置Layui模块的基础目录
        }).extend({
            tmpl: 'tmpl' // 定义tmpl模块
        });
        layui.use(['table', 'form', 'laydate', 'layer', 'laytpl'], function () {
            var table = layui.table;
            var form = layui.form;
            var laydate = layui.laydate;
            var layer = layui.layer;
            var laytpl = layui.laytpl;
            var $ = layui.$;

            // 配置Layui模板语法
            laytpl.config({
                open: '<%',
                close: '%>'
            });

            // 初始化日期范围选择
            laydate.render({
                elem: '#dateRange',
                range: true
            });

            // 初始化表格
            table.render({
                elem: '#withdrawTable',
                url: '/admin/finance/take_cash/json', // 替换为你的API地址
                request: {
                    pageName: 'page' //页码的参数名称，默认：page
                    , limitName: 'pagesize' //每页数据量的参数名，默认：limit
                },
                cols: [[
                    { field: 'id', title: 'ID', width: 80, sort: true },
                    { field: 'company_name', title: '所属公司', width: 200 },
                    { field: 'truename', title: '司机姓名', width: 120 },
                    { field: 'phone', title: '手机号', width: 150 },
                    { field: 'bank_name', title: '银行名称', width: 150 },
                    { field: 'bank_card', title: '银行卡号', width: 180 },
                    {
                        field: 'amount', title: '提现金额', width: 120, templet: function (d) {
                            return '¥' + d.amount;
                        }
                    },
                    { field: 'status', title: '状态', width: 120, templet: '#statusTpl' },
                    { field: 'created_at', title: '申请时间', width: 180, sort: true },
                    { field: 'operation', title: '操作', width: 200, toolbar: '#operationTpl' }
                ]],
                page: true,
                limit: 20,
                limits: [10, 20, 50, 100],
                toolbar: true,
                defaultToolbar: ['filter', 'print', 'exports'],
                response: {
                    statusName: 'status'
                    , statusCode: 0
                },
                done: function (res, curr, count) {
                    // 数据渲染完成后回调
                }
                , parseData: function (res) {
                    if (_company.length == 0) {
                        _company = res.other.company
                        var html = ''
                        html += '<option value="">全部</option>'
                        for (let i in _company) {
                            html += '<option value="' + _company[i].id + '">' + _company[i].name + '</option>'
                        }
                        $("#company").html(html)
                        form.render('select')
                    }
                    if (_total.length == 0) {
                        _total = res.other.total
                        $("#today").html(_total.total_amount == null ? 0 : _total.total_amount)
                        $("#week").html(_total.week_total_amount == null ? 0 : _total.week_total_amount)
                        $("#month").html(_total.month_total_amount == null ? 0 : _total.month_total_amount)
                        $("#noverify").html(_total.verifying == null ? 0 : _total.verifying)
                    }
                    return {
                        "status": res.status
                        , "msg": res.msg
                        , "count": res.other.total
                        , "data": res.data
                    };
                }
            });

            // 搜索功能
            form.on('submit(search)', function (data) {
                console.log(data)
                table.reload('withdrawTable', {
                    where: data.field
                });
                return false;
            });

            // 表格操作监听
            table.on('tool(withdrawTable)', function (obj) {
                var data = obj.data;
                var event = obj.event;

                if (event === 'approve') {
                    showAuditDialog(data, 'approve');
                } else if (event === 'reject') {
                    showAuditDialog(data, 'reject');
                } else if (event === 'view') {
                    viewDetail(data);
                }
            });

            // 显示审核对话框
            function showAuditDialog(data, type) {
                $('#withdrawAmount').val('¥' + data.amount);//.toFixed(2));
                $('#bankInfo').val(data.bank_name + '\n' + data.bank_card);
                let _h = '360px'
                if (type === 'reject') {
                    _h = '450px'
                    $('#rejectReasonItem').show();
                } else {
                    $('#rejectReasonItem').hide();
                }

                var title = type === 'approve' ? '通过提现申请' : '拒绝提现申请';

                layer.open({
                    type: 1,
                    title: title,
                    area: ['500px', _h],
                    content: $('#auditDialog'),
                    btn: [],
                    success: function () {
                        // 对话框打开后回调
                    },
                    yes: function (index, layero) {
                        // 确认按钮回调
                    },
                    cancel: function () {
                        // 关闭回调
                    }
                });

                // 保存当前操作的数据和类型
                $('#auditDialog').data('withdrawData', data);
                $('#auditDialog').data('auditType', type);
            }

            // 确认审核
            form.on('submit(confirmAudit)', function (data) {
                var withdrawData = $('#auditDialog').data('withdrawData');
                var auditType = $('#auditDialog').data('auditType');
                var rejectReason = $('#rejectReason').val();

                // 如果是拒绝操作，必须填写原因
                if (auditType === 'reject' && !rejectReason) {
                    layer.msg('请填写拒绝原因', { icon: 2 });
                    return false;
                }

                // 显示加载中
                var loading = layer.load(2);

                // 发送审核请求
                $.ajax({
                    url: '/admin/finance/take_cash/audit',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        id: withdrawData.id,
                        type: auditType,
                        reason: rejectReason
                    },
                    success: function (res) {
                        layer.close(loading);
                        if (res.status === 0) {
                            layer.closeAll();
                            layer.msg('操作成功', { icon: 1 });
                            // 刷新表格
                            table.reload('withdrawTable');
                        } else {
                            layer.msg(res.msg || '操作失败', { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layer.msg('请求失败，请稍后重试', { icon: 2 });
                    }
                });

                return false;
            });

            // 取消审核
            $('#cancelAudit').on('click', function () {
                layer.closeAll();
            });

            // 查看详情
            function viewDetail(data) {
                layer.open({
                    type: 1,
                    title: '提现申请详情',
                    area: ['600px', '500px'],
                    content: '<div class="layui-card" style="margin:0;">' +
                        '<div class="layui-card-header">基本信息</div>' +
                        '<div class="layui-card-body">' +
                        '<div class="layui-row">' +
                        '<div class="layui-col-md6">' +
                        '<p><span style="color:#999;">司机姓名：</span>' + data.truename + '</p>' +
                        '<p><span style="color:#999;">手机号：</span>' + data.phone + '</p>' +
                        '<p><span style="color:#999;">申请时间：</span>' + data.created_at + '</p>' +
                        '</div>' +
                        '<div class="layui-col-md6">' +
                        '<p><span style="color:#999;">提现金额：</span>¥' + data.amount + '</p>' +
                        '<p><span style="color:#999;">当前状态：</span>' + getStatusText(data.status) + '</p>' +
                        '</div>' +
                        '</div>' +
                        '</div>' +
                        '<div class="layui-card-header">银行信息</div>' +
                        '<div class="layui-card-body">' +
                        '<p><span style="color:#999;">银行名称：</span>' + data.bank_name + '</p>' +
                        '<p><span style="color:#999;">银行卡号：</span>' + data.bank_card + '</p>' +
                        '</div>' +
                        (data.status == 3 ? '<div class="layui-card-header">拒绝原因</div><div class="layui-card-body">' + data.remark + '</div>' : '') +
                        '</div>',
                    btn: ['关闭'],
                    btnAlign: 'c',
                    yes: function (index, layero) {
                        layer.close(index);
                    }
                });
            }

            // 获取状态文本
            function getStatusText(status) {
                var statusMap = {
                    0: '待审核',
                    1: '审核中',
                    2: '已通过',
                    3: '已拒绝',
                    4: '已打款'
                };
                return statusMap[status] || '未知状态';
            }

            // 导出数据
            $('#exportBtn').on('click', function () {
                var loading = layer.load(2);
                $.ajax({
                    url: '',
                    type: 'GET',
                    dataType: 'json',
                    data: {}, // 可以传递当前筛选条件
                    success: function (res) {
                        layer.close(loading);
                        if (res.code === 0 && res.data.url) {
                            window.open(res.data.url);
                        } else {
                            layer.msg(res.msg || '导出失败', { icon: 2 });
                        }
                    },
                    error: function () {
                        layer.close(loading);
                        layer.msg('导出请求失败', { icon: 2 });
                    }
                });
            });
        });
    </script>
</body>

</html>