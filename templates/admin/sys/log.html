{% extends '/admin/common/base.html' %}

{% block content %}
<div class="container-fluid p-t-15">


    <div class="row">



        <div class="col-lg-12">
            <div class="card">

                <div class="card-body">
                    <script type="text/html" id="toolbarDemo">
                        <div class="layui-btn-container">
                            <button class="layui-btn layui-btn-sm" lay-event="clear_log">清空日志</button>
                        </div>
                    </script>
                    <table id="test" lay-filter="test"></table>
                    <script type="text/html" id="barDemo">
                        <a lay-event="del" class="btn btn-xs btn-default btn-delete" data-id="" href="javascript:void(0)" title="删除" data-toggle="tooltip"><i class="mdi mdi-window-close"></i>删除</a>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.getFullYear() + '-' +
            String(date.getMonth() + 1).padStart(2, '0') + '-' +
            String(date.getDate()).padStart(2, '0') + ' ' +
            String(date.getHours()).padStart(2, '0') + ':' +
            String(date.getMinutes()).padStart(2, '0') + ':' +
            String(date.getSeconds()).padStart(2, '0');
    }
    layui.use(['table'], function () {
        var table = layui.table
            , $ = layui.$
            , laytpl = layui.laytpl

        //全局设定某参数
        table.set({
            where: {
                token: ''
            }
            , defaultToolbar: ["filter", "exports", "print"]
            , toolbar: true
            , loading: true
        });

        var option = {
            elem: '#test'
            , toolbar: '#toolbarDemo'
            , height: 600
            , title: '操作日志'
            , url: '/admin/user/log/json'
            , request: {
                pageName: 'page' //页码的参数名称，默认：page
                , limitName: 'pagesize' //每页数据量的参数名，默认：limit
            }
            , page: true
            , limit: 50
            , loading: true
            , limits: [50, 100, 200]
            , cols: [[
                { field: 'id', title: '编号', sort: true, width: 100, hide: false }
                , { field: 'username', title: '登录帐号', width: 150 }
                , { field: 'truename', title: '姓名', width: 150 }
                , { field: 'phone', title: '联系电话', width: 150 }
                , { field: 'content', title: '日志内容' }
                , { field: 'created_at', title: '日志时间', width: 180 }
                // , { fixed: 'right', title: '操作', toolbar: '#barDemo', width: 120 }

            ]]
            , error: function (res, msg) {
            }
            , response: {
                statusName: 'status'
                , statusCode: 0
            }
            , done: function () {
                //当数据渲染完后，执行的回调
                //$('.layui-table-cell').css('height','42px');
            }
            , parseData: function (res) {
                for (let i in res.data)
                    res.data[i].created_at = formatDateTime(res.data[i].created_at)

                return {
                    "status": res.status
                    , "msg": res.msg
                    , "count": res.other
                    , "data": res.data
                };
            }

        }

        table.render(option);

        table.on('toolbar(test)', function (obj) {

            var othis = lay(this);
            if (obj.event == 'clear_log') {
                layer.confirm('确定清空日志？', {
                    icon: 3,
                    btn: ['确定', '取消'],
                }, function (index) {
                    layer.close(index)
                    $.ajax({
                        url: '/admin/user/log',
                        dataType: 'json',
                        type: 'post',
                        success: function (res) {
                            if (res.status != 0) {
                                msg(res.msg);
                                return;
                            }
                            msg(res.msg);
                            table.reload('test', {})
                        }

                    })
                }, function () {
                    layer.close(index)
                });
            }
        });

        table.on('tool(test)', function (obj) {
            var data = obj.data;
            if (obj.event == 'del') {
                $.confirm({
                    title: '提示',
                    content: '确定删除当前记录？',
                    type: 'red',
                    typeAnimated: true,
                    buttons: {
                        tryAgain: {
                            text: '是的',
                            btnClass: 'btn-red',
                            action: function () {
                                $.ajax({
                                    url: '/admin/suggest/delete',
                                    data: { 'id': data.id },
                                    dataType: 'json',
                                    type: 'post',
                                    success: function (res) {
                                        if (res.status != 0) {
                                            msg(res.msg);
                                            return;
                                        }
                                        msg(res.msg);
                                        //$("#tr_" + id).remove();
                                        obj.del()
                                    }
                                })
                            }
                        },
                        close: {
                            text: '取消'
                        }
                    }
                });
            }
        });

    });


</script>

{% endblock %}