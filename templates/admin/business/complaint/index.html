<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网约车平台 - 投诉管理</title>
    <!-- 引入Element-UI样式 -->
    <link rel="stylesheet" href="/static/libs/element-ui/css/element-ui.css">
    <!-- 引入字体图标 -->
    <link rel="stylesheet" href="//at.alicdn.com/t/c/font_4790197_oudfd3w0r9.css">
    <style>
        body {
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
        }
        .app-container {
            padding: 20px;
        }
        .header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-container {
            background-color: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        }
        .pagination {
            margin-top: 20px;
            text-align: right;
        }
        .complaint-content {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .status-pending {
            color: #E6A23C;
        }
        .status-processing {
            color: #409EFF;
        }
        .status-resolved {
            color: #67C23A;
        }
        .complaint-type-driver {
            background-color: #f0f7ff;
            color: #409EFF;
        }
        .complaint-type-platform {
            background-color: #f0f9eb;
            color: #67C23A;
        }
        .detail-dialog .el-dialog__body {
            max-height: 60vh;
            overflow-y: auto;
        }
        .image-preview {
            width: 100px;
            height: 100px;
            margin-right: 10px;
            margin-bottom: 10px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app-container">
            <!-- 头部区域 -->
            <div class="header">
            </div>

            <!-- 搜索区域 -->
            <el-card shadow="never" class="search-card">
                <el-form :inline="true" :model="searchForm" class="demo-form-inline">
                    <el-form-item label="投诉单号">
                        <el-input v-model="searchForm.id" placeholder="请输入投诉单号" clearable></el-input>
                    </el-form-item>
                    <el-form-item label="投诉人">
                        <el-input v-model="searchForm.complainant" placeholder="请输入投诉人" clearable></el-input>
                    </el-form-item>
                    <el-form-item label="被投诉人">
                        <el-input v-model="searchForm.respondent" placeholder="请输入被投诉人" clearable></el-input>
                    </el-form-item>
                    <el-form-item label="投诉类型">
                        <el-select v-model="searchForm.type" placeholder="请选择类型" clearable>
                            <el-option label="全部" value=""></el-option>
                            <el-option label="投诉司机" value="driver"></el-option>
                            <el-option label="投诉平台" value="platform"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="处理状态">
                        <el-select v-model="searchForm.status" placeholder="请选择状态" clearable>
                            <el-option label="全部" value=""></el-option>
                            <el-option label="待处理" value="pending"></el-option>
                            <el-option label="处理中" value="processing"></el-option>
                            <el-option label="已处理" value="resolved"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="投诉时间">
                        <el-date-picker
                            v-model="searchForm.dateRange"
                            type="daterange"
                            range-separator="至"
                            start-placeholder="开始日期"
                            end-placeholder="结束日期"
                            value-format="yyyy-MM-dd">
                        </el-date-picker>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" @click="handleSearch">查询</el-button>
                        <el-button @click="refreshList" icon="el-icon-refresh">刷新</el-button>
                    </el-form-item>
                </el-form>
            </el-card>

            <!-- 表格区域 -->
            <div class="table-container">
                <el-table
                    :data="tableData"
                    border
                    style="width: 100%"
                    v-loading="loading">
                    <el-table-column
                        prop="id"
                        label="投诉单号"
                        width="120">
                    </el-table-column>
                    <el-table-column
                        prop="type"
                        label="投诉类型"
                        width="120">
                        <template slot-scope="scope">
                            <el-tag :class="'complaint-type-' + scope.row.type" size="small">
                                ${ formatType(scope.row.type) }
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column
                        prop="complainant"
                        label="投诉人"
                        width="120">
                    </el-table-column>
                    <el-table-column
                        prop="respondent"
                        label="被投诉人"
                        width="120">
                    </el-table-column>
                    <el-table-column
                        prop="content"
                        label="投诉内容"
                        class-name="complaint-content">
                        <template slot-scope="scope">
                            <div class="complaint-content">${ scope.row.content }</div>
                        </template>
                    </el-table-column>
                    <!-- <el-table-column
                        prop="images"
                        label="投诉图片"
                        width="100">
                        <template slot-scope="scope">
                            <el-image
                                v-if="scope.row.images && scope.row.images.length > 0"
                                style="width: 40px; height: 40px"
                                :src="scope.row.images[0]"
                                fit="cover"
                                :preview-src-list="scope.row.images">
                            </el-image>
                            <span v-else>无</span>
                        </template>
                    </el-table-column> -->
                    <el-table-column
                        prop="create_time"
                        label="投诉时间"
                        width="160">
                    </el-table-column>
                    <el-table-column
                        prop="status"
                        label="处理状态"
                        width="120">
                        <template slot-scope="scope">
                            <el-tag :class="'status-' + scope.row.status" size="small">
                                ${ formatStatus(scope.row.status) }
                            </el-tag>
                        </template>
                    </el-table-column>
                    <el-table-column
                        prop="handler"
                        label="处理人"
                        width="120">
                    </el-table-column>
                    <el-table-column
                        label="操作"
                        width="220">
                        <template slot-scope="scope">
                            <el-button
                                size="mini"
                                @click="handleDetail(scope.$index, scope.row)">详情</el-button>
                            <el-button
                                size="mini"
                                type="primary"
                                @click="handleProcess(scope.$index, scope.row)"
                                v-if="scope.row.status === 'pending' || scope.row.status === 'processing'">处理</el-button>
                            <el-button
                                size="mini"
                                type="danger"
                                @click="handleDelete(scope.$index, scope.row)">删除</el-button>
                        </template>
                    </el-table-column>
                </el-table>

                <!-- 分页 -->
                <div class="pagination">
                    <el-pagination
                        @size-change="handleSizeChange"
                        @current-change="handleCurrentChange"
                        :current-page="currentPage"
                        :page-sizes="[10, 20, 50, 100]"
                        :page-size="pageSize"
                        layout="total, sizes, prev, pager, next, jumper"
                        :total="total">
                    </el-pagination>
                </div>
            </div>
        </div>

        <!-- 投诉详情对话框 -->
        <el-dialog title="投诉详情" :visible.sync="detailDialogVisible" width="60%" class="detail-dialog">
            <el-descriptions :column="2" border>
                <el-descriptions-item label="投诉单号">${ currentComplaint.id }</el-descriptions-item>
                <el-descriptions-item label="投诉类型">${ formatType(currentComplaint.type) }</el-descriptions-item>
                <el-descriptions-item label="投诉人">${ currentComplaint.complainant }</el-descriptions-item>
                <el-descriptions-item label="被投诉人">${ currentComplaint.respondent }</el-descriptions-item>
                <el-descriptions-item label="投诉时间">${ currentComplaint.create_time }</el-descriptions-item>
                <el-descriptions-item label="处理状态">
                    <el-tag :class="'status-' + currentComplaint.status" size="small">
                        ${ formatStatus(currentComplaint.status) }
                    </el-tag>
                </el-descriptions-item>
                <el-descriptions-item label="处理人" :span="2">${ currentComplaint.handler || '未处理' }</el-descriptions-item>
                <el-descriptions-item label="投诉内容" :span="2">
                    <div style="white-space: pre-line;">${ currentComplaint.content }</div>
                </el-descriptions-item>
                <el-descriptions-item label="投诉图片" :span="2">
                    <div v-if="currentComplaint.images && currentComplaint.images.length > 0">
                        <el-image
                            v-for="(img, index) in currentComplaint.images"
                            :key="index"
                            class="image-preview"
                            :src="img"
                            fit="cover"
                            :preview-src-list="currentComplaint.images">
                        </el-image>
                    </div>
                    <span v-else>无</span>
                </el-descriptions-item>
                <el-descriptions-item label="处理结果" :span="2" v-if="currentComplaint.status === 'resolved'">
                    <div style="white-space: pre-line;">${ currentComplaint.process_result || '无' }</div>
                </el-descriptions-item>
            </el-descriptions>
            
            <span slot="footer" class="dialog-footer">
                <el-button @click="detailDialogVisible = false">关 闭</el-button>
            </span>
        </el-dialog>

        <!-- 处理投诉对话框 -->
        <el-dialog :title="'处理投诉 - ' + currentComplaint.id" :visible.sync="processDialogVisible" width="50%">
            <el-form :model="processForm" :rules="processRules" ref="processForm" label-width="100px">
                <el-form-item label="当前状态">
                    <el-tag :class="'status-' + currentComplaint.status" size="medium">
                        ${ formatStatus(currentComplaint.status) }
                    </el-tag>
                </el-form-item>
                
                <el-form-item label="处理状态" prop="status">
                    <el-radio-group v-model="processForm.status">
                        <el-radio label="processing">处理中</el-radio>
                        <el-radio label="resolved">已处理</el-radio>
                    </el-radio-group>
                </el-form-item>
                
                <el-form-item label="处理结果" prop="process_result" v-if="processForm.status === 'resolved'">
                    <el-input
                        type="textarea"
                        :rows="5"
                        v-model="processForm.process_result"
                        placeholder="请输入处理结果，将同步给投诉人和被投诉人"></el-input>
                </el-form-item>
            </el-form>
            
            <span slot="footer" class="dialog-footer">
                <el-button @click="processDialogVisible = false">取 消</el-button>
                <el-button type="primary" @click="submitProcess">确 定</el-button>
            </span>
        </el-dialog>
    </div>

    <!-- 引入Vue和Element-UI -->
    <script src="/static/libs/element-ui/js/vue.js"></script>
    <script src="/static/libs/element-ui/js/element-ui.js"></script>
    <script src="/static/libs/axios.min.js"></script>
    
    <script>
        new Vue({
            el: '#app',
            delimiters: ['${', '}'],
            data() {
                return {
                    // 搜索表单
                    searchForm: {
                        id: '',
                        complainant: '',
                        respondent: '',
                        type: '',
                        status: '',
                        dateRange: []
                    },
                    
                    // 表格数据
                    tableData: [],
                    loading: false,
                    currentPage: 1,
                    pageSize: 10,
                    total: 0,
                    
                    // 详情对话框
                    detailDialogVisible: false,
                    currentComplaint: {
                        id: '',
                        type: '',
                        complainant: '',
                        respondent: '',
                        content: '',
                        images: [],
                        create_time: '',
                        status: '',
                        handler: '',
                        process_result: ''
                    },
                    
                    // 处理对话框
                    processDialogVisible: false,
                    processForm: {
                        status: 'processing',
                        process_result: ''
                    },
                    processRules: {
                        status: [
                            { required: true, message: '请选择处理状态', trigger: 'change' }
                        ],
                        process_result: [
                            { required: true, message: '请输入处理结果', trigger: 'blur' },
                            { min: 10, message: '处理结果至少10个字符', trigger: 'blur' }
                        ]
                    },
                    currentProcessIndex: -1
                }
            },
            created() {
                this.getList();
            },
            methods: {
                // 格式化投诉类型
                formatType(type) {
                    const types = {
                        'driver': '投诉司机',
                        'platform': '投诉平台'
                    };
                    return types[type] || type;
                },
                
                // 格式化处理状态
                formatStatus(status) {
                    const statuses = {
                        'pending': '待处理',
                        'processing': '处理中',
                        'resolved': '已处理'
                    };
                    return statuses[status] || status;
                },
                
                // 获取投诉列表
                getList() {
                    this.loading = true;
                    // 模拟API请求
                    setTimeout(() => {
                        // 这里应该是axios请求
                        // axios.get('/api/complaint/list', {
                        //     params: {
                        //         page: this.currentPage,
                        //         size: this.pageSize,
                        //         ...this.searchForm
                        //     }
                        // }).then(response => {
                        //     this.tableData = response.data.list;
                        //     this.total = response.data.total;
                        //     this.loading = false;
                        // });
                        
                        // 模拟数据
                        this.tableData = [
                            {
                                id: 'C20231015001',
                                type: 'driver',
                                complainant: '张先生 (乘客)',
                                respondent: '李师傅 (司机)',
                                content: '司机绕路行驶，比预计路线多走了5公里，导致车费增加。',
                                images: [
                                    'https://via.placeholder.com/150?text=投诉图片1',
                                    'https://via.placeholder.com/150?text=投诉图片2'
                                ],
                                create_time: '2023-10-15 09:30:25',
                                status: 'pending',
                                handler: '',
                                process_result: ''
                            },
                            {
                                id: 'C20231014002',
                                type: 'platform',
                                complainant: '王师傅 (司机)',
                                respondent: '平台系统',
                                content: '平台抽成比例突然从15%提高到20%，没有提前通知，要求解释。',
                                images: [],
                                create_time: '2023-10-14 14:15:10',
                                status: 'processing',
                                handler: '管理员',
                                process_result: '已联系财务部门核实，系统显示抽成比例确实有误，将在3个工作日内退还多扣款项。'
                            },
                            {
                                id: 'C20231012003',
                                type: 'driver',
                                complainant: '刘女士 (乘客)',
                                respondent: '赵师傅 (司机)',
                                content: '司机服务态度恶劣，途中多次言语侮辱，要求平台严肃处理。',
                                images: [
                                    'https://via.placeholder.com/150?text=录音证据'
                                ],
                                create_time: '2023-10-12 18:45:30',
                                status: 'resolved',
                                handler: '客服主管',
                                process_result: '经核实，司机确实存在不当言行，已对司机账号进行7天封禁处理，并向乘客赠送30元优惠券作为补偿。'
                            }
                        ];
                        this.total = 3;
                        this.loading = false;
                    }, 500);
                },
                
                // 刷新列表
                refreshList() {
                    this.currentPage = 1;
                    this.getList();
                },
                
                // 搜索
                handleSearch() {
                    this.currentPage = 1;
                    this.getList();
                },
                
                // 分页大小改变
                handleSizeChange(val) {
                    this.pageSize = val;
                    this.getList();
                },
                
                // 当前页改变
                handleCurrentChange(val) {
                    this.currentPage = val;
                    this.getList();
                },
                
                // 查看详情
                handleDetail(index, row) {
                    this.currentComplaint = { ...row };
                    this.detailDialogVisible = true;
                },
                
                // 处理投诉
                handleProcess(index, row) {
                    this.currentComplaint = { ...row };
                    this.currentProcessIndex = index;
                    this.processForm = {
                        status: row.status === 'pending' ? 'processing' : row.status,
                        process_result: row.process_result || ''
                    };
                    this.processDialogVisible = true;
                },
                
                // 提交处理
                submitProcess() {
                    this.$refs.processForm.validate((valid) => {
                        if (valid) {
                            // 模拟API请求
                            // axios.post('/api/complaint/process', {
                            //     id: this.currentComplaint.id,
                            //     ...this.processForm
                            // }).then(response => {
                            //     this.$message.success('处理成功');
                            //     this.processDialogVisible = false;
                            //     this.getList();
                            // });
                            
                            // 模拟成功
                            const handlerName = '管理员'; // 实际应为当前登录用户
                            const updatedComplaint = {
                                ...this.currentComplaint,
                                status: this.processForm.status,
                                process_result: this.processForm.process_result || '',
                                handler: handlerName
                            };
                            
                            this.tableData.splice(this.currentProcessIndex, 1, updatedComplaint);
                            this.$message.success('处理成功');
                            this.processDialogVisible = false;
                        } else {
                            this.$message.error('请填写完整信息');
                            return false;
                        }
                    });
                },
                
                // 删除投诉
                handleDelete(index, row) {
                    this.$confirm('确定要删除这条投诉记录吗?', '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        // 模拟API请求
                        // axios.post('/api/complaint/delete', { id: row.id })
                        //     .then(response => {
                        //         this.$message.success('删除成功');
                        //         this.getList();
                        //     });
                        
                        // 模拟成功
                        this.tableData.splice(index, 1);
                        this.total -= 1;
                        this.$message.success('删除成功');
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                }
            }
        });
    </script>
</body>
</html>