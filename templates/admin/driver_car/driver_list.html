{% extends '/admin/common/base.html' %}

{% block content %}
<div class="container-fluid p-t-15">

    <div class="row">
        <div class="col-lg-12">
            <div class="card">

                <div class="card-toolbar clearfix">

                    <div class="card-header" style="padding-left: 0px !important;">
                        <div class="col-xs-12">
                            <form id="myform">
                                <div class="input-group m-b-10">
                                    <span class="input-group-addon" id="basic-addon1">姓名</span>
                                    <input class="form-control" type="text" name="name" id="name" placeholder=""
                                        autocomplete="off" value="">
                                    <span class="input-group-addon" id="basic-addon1">电话</span>
                                    <input class="form-control" type="text" id="phone" placeholder="" autocomplete="off"
                                        value="">
                                    <span class="input-group-addon" id="basic-addon1">车牌号</span>
                                    <input class="form-control" type="text" id="car_no" placeholder=""
                                        autocomplete="off" value="">
                                    <span class="input-group-addon" id="basic-addon1">所属公司</span>
                                    <select class="form-control" id="company" name="company">
                                        <option value="">请选择</option>
                                        <!-- 这里可以动态加载公司列表 -->
                                    </select>
                                    <span class="input-group-addon" id="basic-addon1">注册时间</span>
                                    <input class="form-control js-datepicker" type="text" id="btime" name="btime"
                                        data-date-format="yyyy-mm-dd" placeholder="从" autocomplete="off" value="">
                                    <span class="input-group-addon"><i class="mdi mdi-chevron-right"></i></span>
                                    <input class="form-control js-datepicker" type="text" id="etime" name="etime"
                                        data-date-format="yyyy-mm-dd" placeholder="至" autocomplete="off" value="">
                                    <a href="#" class="search-btn a-submit btn btn-default input-group-addon"
                                        id="basic-addon1"> <i class="mdi mdi-search-web"></i> 查询</a>
                                    <a href="#" class="ref-btn btn btn-default input-group-addon" id="basic-addon1"> <i
                                            class="mdi mdi-reload"></i> 刷新</a>
                                </div>
                            </form>
                        </div>
                    </div>

                </div>

                <div class="card-body">
                    <table id="test" lay-filter="test"></table>
                    <script type="text/html" id="barDemo">
                        <a lay-event='edit' class="layui-btn layui-btn-xs layui-btn-default" href="javascript:void(0)">订单</a>
                        <a lay-event='view' class="layui-btn layui-btn-xs" href="javascript:void(0)">优惠券</a>
                        <a lay-event="del" class="layui-btn layui-btn-xs layui-btn-danger btn-delete" data-id="" href="javascript:void(0)">删除</a>
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function formatDateTime(dateStr) {
        const date = new Date(dateStr);
        return date.getUTCFullYear() + '-' +
            String(date.getUTCMonth() + 1).padStart(2, '0') + '-' +
            String(date.getUTCDate()).padStart(2, '0') + ' ' +
            String(date.getUTCHours()).padStart(2, '0') + ':' +
            String(date.getUTCMinutes()).padStart(2, '0') + ':' +
            String(date.getUTCSeconds()).padStart(2, '0');
    }
    function formatDuration(duration) {
        if (isNaN(duration) || duration == '' || duration == null)
            return ''

        duration = parseInt(duration)
        if (duration <= 0)
            return ''

        if (duration < 60)
            return `1分钟`
        else if (duration < 3600)
            return `${Math.floor(duration / 60)}分钟`
        else
            return `${Math.floor(duration / 3600)}小时`
    }

    function view_img(id, title, img) {
        layui.use(function () {

            layer.photos({
                photos: { // 图片层的数据源
                    "title": "", // 相册标题
                    "id": 123, // 相册 id
                    "start": 0, // 初始显示的图片序号，默认 0
                    "data": [   // 相册包含的图片，数组格式
                        {
                            "alt": title,
                            "pid": id,
                            "src": img, // 原图地址
                            "thumb": img // 缩略图地址
                        },
                    ]
                },
                tab: function (data, layero) { // 图片层切换后的回调
                    console.log(data); // 当前图片数据信息
                    console.log(layero); // 图片层的容器对象
                }
            });

        });
    }
    layui.use(['table'], function () {
        var table = layui.table
            , $ = layui.$
            , laytpl = layui.laytpl
            , laydate = layui.laydate;
        laydate.render({
            elem: '#btime'
        });
        var form = layui.form;
        laydate.render({
            elem: '#etime'
        });


        //全局设定某参数
        table.set({
            where: {
                token: ''
            }
            , defaultToolbar: ["filter", "exports", "print"]
            , toolbar: true
            , loading: true
        });

        var option = {
            elem: '#test'
            , toolbar: '#toolbarDemo'
            , height: 500
            , title: '司机列表'
            , url: '/admin/driver/list/json'
            , request: {
                pageName: 'page' //页码的参数名称，默认：page
                , limitName: 'pagesize' //每页数据量的参数名，默认：limit
            }
            , page: true
            , limit: 50
            , loading: true
            , limits: [50, 100, 200]
            , cols: [[
                { field: 'id', title: '编号', sort: true, width: 100 }
                , { field: 'truename', title: '姓名', width: 120 }
                , { field: 'phone', title: '电话', width: 160 }
                , {
                    field: 'sex', title: '性别', width: 100, templet: function (d) {
                        if (d.sex == 0) {
                            return '男';
                        } else {
                            return '女';
                        }
                    }
                }
                , {
                    field: 'id_card', title: '身份证', width: 180, templet: function (d) {
                        if (d.id_card == null)
                            return ""
                        return `<a href="#" onclick="view_img(${d.id},'身份证','${d.id_card_img}')">${d.id_card}</a>`
                    }
                }
                , { field: 'score', title: '综合评分', width: 120 }
                , {
                    field: 'accept_order_status', title: '接单状态', width: 120, templet: function (d) {
                        if (d.accept_order_status == 1) {
                            return '<span class="layui-font-green">接送乘客</span>';
                        } else {
                            return '<span class="layui-font-gray">空闲</span>';
                        }
                    }
                }
                , {
                    field: 'work_status', title: '工作状态', width: 120, templet: function (e) {
                        if (e.work_status == 1) {
                            return '<span class="layui-font-green">接单中</span>';
                        }else {
                            return '<span class="layui-font-gray">下班</span>';
                        }
                    }
                }
                , {
                    field: 'status', title: '用户状态', width: 120, templet: function (d) {
                        if (d.status == 0)
                            return `<input type="checkbox" name="status" value="${d.status}" data-id="${d.id}" lay-skin="switch" lay-text="正常|禁用" lay-filter="demo-templet-status" checked>`
                        else
                            return `<input type="checkbox" name="status" value="${d.status}" data-id="${d.id}" lay-skin="switch" lay-text="正常|禁用" lay-filter="demo-templet-status">`

                        // 使用以下方法时 form.on('switch(demo-templet-status)'
                        //return `<input type="checkbox" name="status" value="${d.id}" title="热|" lay-filter="demo-templet-status" checked>`
                    }
                }
                , { field: 'order_count', title: '接单数量', width: 120 ,templet:function(d){
                    return '<span class="layui-font-blue">' + d.order_count + '</span>';
                }}
                , { field: 'total_fee', title: '订单金额', width: 120,templet:function(d){
                    let total_fee = parseFloat(d.total_fee);
                    if(d.total_fee == null || isNaN(total_fee))
                        total_fee = 0
                    return '<span class="layui-font-red">' + total_fee + '</span>';
                } }
                , { field: 'order_commission', title: '订单佣金', width: 120,templet:function(d){
                    let order_commission = parseFloat(d.order_commission);
                    if(order_commission == null || isNaN(order_commission))
                        order_commission = 0

                    return '<span class="layui-font-blue">' + order_commission + '</span>';
                } }
                , { field: 'coupons_num', title: '优惠券数量', width: 120,templet:function(d){
                     return '<span class="layui-font-green">' + d.coupons_num + '</span>';
                } }
                , {
                    field: 'today_online_total_time', title: '当天工作时长', width: 160, templet: function (d) {
                        return formatDuration(d.today_online_total_time)
                    }
                }
                , {
                    field: 'total_online_time', title: '累计工作时长', width: 160, templet: function (d) {
                        return formatDuration(d.total_online_time)
                    }
                }
                , {
                    field: 'online_total_time', title: 'APP累计在线时长', width: 160, templet: function (d) {
                        return formatDuration(d.online_total_time)
                    }
                }
                , {
                    field: 'car_no', title: '车牌号', width: 160, templet: function (d) {
                        if (d.car_no == null)
                            return ""
                        return `<a href="#" onclick="view_img(${d.id},'车辆照片','${d.car_img}')">${d.car_no}</a>`
                    }
                }
                , { field: 'car_age', title: '车龄', width: 120 }
                , { field: 'car_brand', title: '品牌', width: 120 }
                , { field: 'car_color', title: '颜色', width: 120 }
                , { field: 'car_type', title: '车辆类型', width: 120 }             
                , {
                    field: 'driving_license', title: '驾驶证', width: 120, templet: function (d) {
                        if (d.driving_license == null)
                            return ""
                        return `<a href="#" onclick="view_img(${d.id},'驾驶证照片','${d.driving_license}')">查看</a>`
                    }
                }
                , {
                    field: 'car_license', title: '行驶证', width: 120, templet: function (d) {
                        if (d.car_license == null)
                            return ""
                        return `<a href="#" onclick="view_img(${d.id},'行驶证照片','${d.car_license}')">查看</a>`
                    }
                }

                , { field: 'created_at', title: '注册时间', width: 180 }
                , { fixed: 'right', title: '操作', toolbar: '#barDemo', width: 200 }
            ]]
            , error: function (res, msg) {
            }
            , response: {
                statusName: 'status'
                , statusCode: 0
            }
            , done: function (res, curr, count) {
                //当数据渲染完后，执行的回调
            }
            , parseData: function (res) {

                return {
                    "status": res.status
                    , "msg": res.msg
                    , "count": res.other
                    , "data": res.data
                };
            }
        }

        table.render(option);

        // 状态 - 开关操作
        form.on('switch(demo-templet-status)', function (obj) {
            console.log(obj)
            var id = obj.elem.attributes["data-id"].value
            var val = parseInt(this.value);
            let msg = ""
            let status = 0
            if (val == 0) {
                msg = "禁用帐户后司机将无法登录及接单，是否禁用？"
                status = -1
            }
            else {
                msg = "确定启用？"
                status = 0
            }

            layer.confirm(msg, {
                icon: 3,
                btn: ['确定', '取消'],
            }, function (index) {
                layer.close(index)
                axios.post('/admin/driver/update/status', {
                    'status': status,
                    'id': id
                }).then(res => {
                    console.log(res)
                    if (res.data.status == 0) {
                        if (val == 0) {
                            obj.elem.value = -1
                            obj.checked = false
                        }
                        else {
                            obj.elem.value = 0
                            obj.elem.checked = true
                        }
                    }
                }).catch(error => {
                    console.log(error)
                });
            }, function (index) {
                console.log(val)
                if (val == 0)
                    obj.elem.checked = true
                else
                    obj.elem.checked = false
            });
        });

        table.on('tool(test)', function (obj) {
            var data = obj.data;
            if (obj.event === 'del') {
                $.confirm({
                    title: '提示',
                    content: '确定删除当前记录？',
                    type: 'red',
                    typeAnimated: true,
                    buttons: {
                        tryAgain: {
                            text: '是的',
                            btnClass: 'btn-red',
                            action: function () {
                                $.ajax({
                                    url: '/admin/driver/delete',
                                    data: { 'id': data.id },
                                    dataType: 'json',
                                    type: 'post',
                                    success: function (res) {
                                        if (res.status != 0) {
                                            msg(res.msg);
                                            return;
                                        }
                                        msg(res.msg);
                                        obj.del()
                                    }
                                })
                            }
                        },
                        close: {
                            text: '取消'
                        }
                    }
                });
            }
            else if (obj.event == 'edit') {
                layer.open({
                    type: 2,
                    title: '订单查看',
                    shadeClose: false,
                    shade: 0.8,
                    area: ['80%', '85%'],
                    content: "/admin/order/list?flag=driver&car_no=" + data.car_no
                })
            }
            else if (obj.event == 'view') {
                layer.open({
                    type: 2,
                    title: '领用记录查看',
                    shadeClose: false,
                    shade: 0.8,
                    area: ['80%', '75%'],
                    content: '/admin/coupons/take/list?flag=0&utype=1&uid=' + data.id
                })
            }
        });

        $(".search-btn").click(function () {
            let n = $("#name").val();
            let p = $("#phone").val();
            let c = $("#company").val();

            option.where = { 'name': n, 'phone': p, 'company': c, 'btime': $("#btime").val(), 'etime': $("#etime").val(), 'car_no': $("#car_no").val() }
            table.render(option)
            return false;
        })

        $(".ref-btn").click(function () {
            $("#name").val('');
            $("#phone").val('');
            $("#company").val('');
            $("#btime").val('')
            $("#etime").val('')
            $("#car_no").val('')
            option.where = {}
            table.render(option)
            return false;
        })

        table.on('edit(test)', function (obj) {
            var field = obj.field; // 得到字段
            var value = obj.value; // 得到修改后的值
            var data = obj.data; // 得到所在行所有键值
            // // 值的校验
            if (field === 'driving_years' || field === 'total_working_hours') {
                if (!/^([0-9_\.\-])+$/.test(obj.value)) {
                    layer.tips('只可输入数值，请重新编辑', this, { tips: 1 });
                    return obj.reedit(); // 重新编辑 -- v2.8.0 新增
                }
            }
            // 编辑后续操作，如提交更新请求，以完成真实的数据更新
            // …
            $.ajax({
                url: '/admin/driver/edit_field',
                data: { 'value': value, 'id': obj.data.id, 'field': field },
                type: 'post',
                dataType: 'json',
                success: function (res) {

                }
            })
            //layer.msg('编辑成功' + field + "," + value, { icon: 1 });

            // 其他更新操作
            var update = {};
            update[field] = value;
            obj.update(update);
        });


    });

    function get_company_list() {
        axios.get('/admin/company/list/json').then(res => {
            if (res.data.status == 0) {
                let html = '<option value="">请选择</option>';
                res.data.data.forEach(item => {
                    html += `<option value="${item.id}">${item.name}</option>`;
                });
                $("#company").html(html);
                layui.form.render('select');
            }
        }).catch(error => {
            console.log(error);
        });
    }

    $(function(){
        get_company_list();
    })
</script>

{% endblock %}